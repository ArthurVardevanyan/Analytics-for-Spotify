<!doctype html>
<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Analytics for Spotify</title>
    <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"
        integrity="sha512-Y51n9mtKTVBh3Jbx5pZSJNDDMyY+yGe77DGtBPzRlgsf/YLCh13kSZ3JmfHGzYFCmOndraf0sQgfM654b7dJ3w=="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="main.css">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css">

    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        .chart-container {
            margin: 20px auto;
            max-width: 900px;
            padding: 20px;
        }
    </style>
</head>

<body>

    <h1 style="margin-bottom: 5px;">Analytics for Spotify</h1>
    <div style="text-align: center;">
        <button onclick="window.location.href = '/analytics/login/';" class="btn btn-spotify">Log In</button>
    </div>

    <div class="chart-container">
        <h2>Global Listening History</h2>
        <canvas id="global-daily-chart" height="80"></canvas>
    </div>

    <div class="chart-container">
        <h2>Global Average Hourly Listens</h2>
        <canvas id="global-hourly-chart" height="80"></canvas>
    </div>

    <div style="text-align: center; margin: 20px; color: #888; font-size: 14px;">
        <p id="last-updated">Loading statistics...</p>
    </div>

    <script>
        window.onload = function () {
            let lastUpdatedTime = null;

            // Load global daily aggregation
            $.ajax({
                url: "/analytics/globalDailyAggregation/",
                method: "GET",
                success(data) {
                    if (data.lastUpdated && !lastUpdatedTime) {
                        lastUpdatedTime = data.lastUpdated;
                    }

                    const lineChart = new Chart(document.getElementById("global-daily-chart"), {
                        type: "line",
                        data: {
                            labels: data.songs,
                            datasets: [{
                                data: data.plays,
                                label: "Daily Listens (All Users)",
                                borderColor: "#1DB954",
                                backgroundColor: "rgba(29, 185, 84, 0.1)",
                                fill: true,
                                tension: 0.4,
                            }],
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                }
                            },
                        },
                    });
                }
            });

            // Load global hourly aggregation
            $.ajax({
                url: "/analytics/globalHourlyAggregation/",
                method: "GET",
                success(data) {
                    if (data.lastUpdated && !lastUpdatedTime) {
                        lastUpdatedTime = data.lastUpdated;
                    }

                    const hourlyChart = new Chart(document.getElementById("global-hourly-chart"), {
                        type: "line",
                        data: {
                            labels: data.songs,
                            datasets: [{
                                data: data.plays,
                                label: "Hourly Listens (All Users)",
                                borderColor: "#1DB954",
                                backgroundColor: "rgba(29, 185, 84, 0.1)",
                                fill: true,
                                tension: 0.4,
                            }],
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                }
                            },
                        },
                    });

                    // Update last updated timestamp
                    if (lastUpdatedTime) {
                        const time = lastUpdatedTime.split(" ");
                        const dt = new Date(time[0] + "T" + time[1]);
                        const localDateTime = dt.toLocaleString();
                        document.getElementById("last-updated").textContent =
                            "Statistics last updated: " + localDateTime + " (refreshes hourly)";
                    }
                }
            });
        };
    </script>

</body>

</html>
